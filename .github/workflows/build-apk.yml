name: Build and Release APK

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ v* æ ‡ç­¾æ—¶è§¦å‘ï¼ˆå¦‚ v1.0.0, v1.1.0ï¼‰
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'
      
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      
      - name: Decode Keystore
        if: ${{ secrets.KEYSTORE_FILE != '' }}
        run: |
          echo "${{ secrets.KEYSTORE_FILE }}" | base64 --decode > release.keystore
          echo "Keystore file created"
          ls -lh release.keystore
      
      - name: Build Debug APK
        run: ./gradlew assembleDebug --stacktrace
      
      - name: Build Release APK
        env:
          KEYSTORE_FILE: ${{ secrets.KEYSTORE_FILE }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          if [ -f "release.keystore" ]; then
            echo "Building signed Release APK..."
            ./gradlew assembleRelease --stacktrace
          else
            echo "Building unsigned Release APK..."
            ./gradlew assembleRelease --stacktrace
          fi
      
      - name: Rename APK files
        run: |
          mkdir -p release-files
          
          # è·å–ç‰ˆæœ¬ä¿¡æ¯
          VERSION_NAME=$(grep "versionName" app/build.gradle | awk '{print $2}' | tr -d '"')
          VERSION_CODE=$(grep "versionCode" app/build.gradle | awk '{print $2}')
          
          # é‡å‘½å Debug APK
          cp app/build/outputs/apk/debug/app-debug.apk \
             release-files/orca-tv-v${VERSION_NAME}-debug.apk
          
          # é‡å‘½å Release APKï¼ˆæ ¹æ®æ˜¯å¦ç­¾åé€‰æ‹©ä¸åŒçš„æ–‡ä»¶åï¼‰
          if [ -f "release.keystore" ]; then
            # å·²ç­¾å
            cp app/build/outputs/apk/release/app-release.apk \
               release-files/orca-tv-v${VERSION_NAME}-release-signed.apk
            echo "SIGNED=true" >> $GITHUB_ENV
          else
            # æœªç­¾å
            cp app/build/outputs/apk/release/app-release-unsigned.apk \
               release-files/orca-tv-v${VERSION_NAME}-release-unsigned.apk || \
            cp app/build/outputs/apk/release/app-release.apk \
               release-files/orca-tv-v${VERSION_NAME}-release-unsigned.apk
            echo "SIGNED=false" >> $GITHUB_ENV
          fi
          
          # ç”Ÿæˆ APK ä¿¡æ¯æ–‡ä»¶
          echo "Orca-tv APK Build Information" > release-files/BUILD_INFO.txt
          echo "==============================" >> release-files/BUILD_INFO.txt
          echo "" >> release-files/BUILD_INFO.txt
          echo "Version Name: ${VERSION_NAME}" >> release-files/BUILD_INFO.txt
          echo "Version Code: ${VERSION_CODE}" >> release-files/BUILD_INFO.txt
          echo "Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> release-files/BUILD_INFO.txt
          echo "Git Commit: ${{ github.sha }}" >> release-files/BUILD_INFO.txt
          echo "Git Ref: ${{ github.ref }}" >> release-files/BUILD_INFO.txt
          echo "Signed: ${{ env.SIGNED }}" >> release-files/BUILD_INFO.txt
          echo "" >> release-files/BUILD_INFO.txt
          echo "APK Files:" >> release-files/BUILD_INFO.txt
          ls -lh release-files/*.apk >> release-files/BUILD_INFO.txt
          
          # å¦‚æœå·²ç­¾åï¼ŒéªŒè¯ç­¾å
          if [ -f "release.keystore" ]; then
            echo "" >> release-files/BUILD_INFO.txt
            echo "APK Signature Information:" >> release-files/BUILD_INFO.txt
            jarsigner -verify -verbose -certs release-files/orca-tv-v${VERSION_NAME}-release-signed.apk >> release-files/BUILD_INFO.txt 2>&1 || true
          fi
      
      - name: Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: orca-tv-debug-apk
          path: release-files/*-debug.apk
          retention-days: 30
      
      - name: Upload Release APK
        uses: actions/upload-artifact@v4
        with:
          name: orca-tv-release-apk
          path: release-files/*-release*.apk
          retention-days: 90
      
      - name: Upload Build Info
        uses: actions/upload-artifact@v4
        with:
          name: build-info
          path: release-files/BUILD_INFO.txt
          retention-days: 90
      
      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release-files/*.apk
            release-files/BUILD_INFO.txt
          body: |
            ## ğŸ‰ Orca-tv æ–°ç‰ˆæœ¬å‘å¸ƒ
            
            ### ğŸ“¦ ä¸‹è½½è¯´æ˜
            
            ${{ env.SIGNED == 'true' && '- **orca-tv-vX.X.X-release-signed.apk**: Release ç‰ˆæœ¬ï¼ˆå·²ç­¾åï¼‰ï¼Œæ¨èä¸‹è½½' || '- **orca-tv-vX.X.X-release-unsigned.apk**: Release ç‰ˆæœ¬ï¼ˆæœªç­¾åï¼‰' }}
            - **orca-tv-vX.X.X-debug.apk**: Debug ç‰ˆæœ¬ï¼ŒåŒ…å«è°ƒè¯•ä¿¡æ¯
            
            ### ğŸ“ å®‰è£…æ–¹æ³•
            
            1. ä¸‹è½½å¯¹åº”çš„ APK æ–‡ä»¶
            2. ä¼ è¾“åˆ° Android TV è®¾å¤‡
            3. ä½¿ç”¨æ–‡ä»¶ç®¡ç†å™¨å®‰è£…
            4. é¦–æ¬¡å¯åŠ¨åè¿›å…¥è®¾ç½®é…ç½® iptv-api åœ°å€
            
            ### âš ï¸ æ³¨æ„äº‹é¡¹
            
            - éœ€è¦ Android 5.0 (API 21) æˆ–æ›´é«˜ç‰ˆæœ¬
            - å»ºè®®åœ¨ Android TV è®¾å¤‡ä¸Šä½¿ç”¨
            ${{ env.SIGNED == 'false' && '- æœªç­¾åç‰ˆæœ¬å®‰è£…æ—¶å¯èƒ½æç¤º"æœªçŸ¥æ¥æº"' || '' }}
            
            ### ğŸ”— ç›¸å…³é“¾æ¥
            
            - [é¡¹ç›®ä¸»é¡µ](https://github.com/yanzhao77/orca-tv)
            - [ä½¿ç”¨æ–‡æ¡£](https://github.com/yanzhao77/orca-tv/blob/main/README.md)
            - [é›†æˆæŒ‡å—](https://github.com/yanzhao77/orca-tv/blob/main/DEVELOPMENT_GUIDE.md)
            
            ---
            
            **å®Œæ•´æ›´æ–°æ—¥å¿—è¯·æŸ¥çœ‹ [CHANGELOG.md](https://github.com/yanzhao77/orca-tv/blob/main/CHANGELOG.md)**
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Clean up Keystore
        if: always()
        run: |
          rm -f release.keystore
          echo "Keystore file removed"
